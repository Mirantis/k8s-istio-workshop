(window.webpackJsonp=window.webpackJsonp||[]).push([[16],{344:function(s,a,t){"use strict";t.r(a);var e=t(9),r=Object(e.a)({},function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"create-vms-in-openstack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#create-vms-in-openstack","aria-hidden":"true"}},[s._v("#")]),s._v(" Create VMs in OpenStack")]),s._v(" "),t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("Screencast: "),t("a",{attrs:{href:"https://asciinema.org/a/229605?autoplay=0&t=1",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://asciinema.org/a/229605?t=1"),t("OutboundLink")],1)])]),s._v(" "),t("p",[s._v("Before you start with the main content of the workshop, you need to provision\nthe VMs in OpenStack.")]),s._v(" "),t("p",[s._v("Create VMs in OpenStack using Ubuntu Docker image.")]),s._v(" "),t("h2",{attrs:{id:"prepare-the-local-working-environment-inside-docker"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#prepare-the-local-working-environment-inside-docker","aria-hidden":"true"}},[s._v("#")]),s._v(" Prepare the local working environment inside Docker")]),s._v(" "),t("p",[s._v("Run Ubuntu docker image and mount the directory there:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" /var/tmp/test "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cd")]),s._v(" /var/tmp/test\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_AUTH_SOCK")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v("\n  docker run -it --rm -e USER"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$USER")]),s._v('"')]),s._v(" -e SSH_AUTH_SOCK"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_AUTH_SOCK")]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_AUTH_SOCK")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v(":")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_AUTH_SOCK")]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PWD")]),s._v(":/mnt -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.ssh:/root/.ssh:ro ubuntu\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v("\n  docker run -it --rm -e USER"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$USER")]),s._v('"')]),s._v(" -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$PWD")]),s._v(":/mnt -v "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.ssh:/root/.ssh:ro ubuntu\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),t("div",{staticClass:"tip custom-block"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("p",[s._v("All commands in the labs should be executed inside the Docker container.\nOnly few "),t("code",[s._v("kubectl")]),s._v(" needs to be executed directly on the PC and it's always\nexplicitly mentioned in the docs.")])]),s._v(" "),t("p",[s._v("Install necessary software into the Docker container:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("apt update -qq\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y -qq apt-transport-https byobu "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" gnupg jq openssh-client psmisc siege "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" unzip vim "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /dev/null\n")])])]),t("p",[s._v("Install "),t("code",[s._v("kubernetes-client")]),s._v(" package:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s https://packages.cloud.google.com/apt/doc/apt-key.gpg "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" apt-key add -\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("echo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"deb https://apt.kubernetes.io/ kubernetes-xenial main"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" /etc/apt/sources.list.d/kubernetes.list\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" update -qq\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt-get")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -y -qq kubectl\n")])])]),t("p",[s._v("Install "),t("a",{attrs:{href:"https://www.terraform.io/",target:"_blank",rel:"noopener noreferrer"}},[s._v("Terraform"),t("OutboundLink")],1),s._v(":")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("TERRAFORM_LATEST_VERSION"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" -s https://checkpoint-api.hashicorp.com/v1/check/terraform "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" jq -r -M "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('".current_version"')]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v(")")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("curl")]),s._v(" --silent --location https://releases.hashicorp.com/terraform/"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TERRAFORM_LATEST_VERSION}")]),s._v("/terraform_"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${TERRAFORM_LATEST_VERSION}")]),s._v("_linux_amd64.zip --output /tmp/terraform_linux_amd64.zip\nunzip -o /tmp/terraform_linux_amd64.zip -d /usr/local/bin/\n")])])]),t("p",[s._v("Change directory to "),t("code",[s._v("/mnt")]),s._v(" where the git repository is mounted:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cd")]),s._v(" /mnt\n")])])]),t("h2",{attrs:{id:"provision-vms-in-openstack"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#provision-vms-in-openstack","aria-hidden":"true"}},[s._v("#")]),s._v(" Provision VMs in OpenStack")]),s._v(" "),t("p",[s._v("Start 3 VMs (one master and 2 workers) where the k8s will be installed.")]),s._v(" "),t("p",[s._v("Terraform diagram:")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://cdn-images-1.medium.com/max/1200/1*lYFNHNM03biX_95IQMayUw.png",alt:"Terraform",title:"Terraform"}}),s._v("\n("),t("a",{attrs:{href:"https://hackernoon.com/terraform-openstack-ansible-d680ea466e22",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://hackernoon.com/terraform-openstack-ansible-d680ea466e22"),t("OutboundLink")],1),s._v(")")]),s._v(" "),t("p",[s._v("Generate ssh keys if not exists:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),s._v(" -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.ssh/id_rsa "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" -m 0700 -d "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.ssh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" ssh-keygen -b 2048 -t rsa -f "),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$HOME")]),s._v("/.ssh/id_rsa -q -N "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('""')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# ssh-agent must be running...")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("test")]),s._v(" -n "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$SSH_AUTH_SOCK")]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("||")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("eval")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("ssh-agent"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token variable"}},[t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")]),s._v("ssh-add -l"),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("`")])]),s._v('"')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"The agent has no identities."')]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("then")]),s._v(" ssh-add"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("fi")]),s._v("\n")])])]),t("p",[s._v("Clone this git repository:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" clone https://github.com/mirantis/k8s-istio-workshop\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cd")]),s._v(" k8s-istio-workshop\n")])])]),t("div",{staticClass:"danger custom-block"},[t("p",{staticClass:"custom-block-title"},[s._v("STOP")]),s._v(" "),t("p",[s._v("Modify the OpenStack access credentials in the following Terraform variable file!")])]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("OPENSTACK_PASSWORD"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("${OPENSTACK_PASSWORD:-default}")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" terrafrom/openstack/terraform.tfvars "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<<")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('EOF\nopenstack_auth_url                          = "https://ic-us.ssl.mirantis.net:5000/v3"\nopenstack_instance_flavor_name              = "dev.log"\nopenstack_instance_image_name               = "bionic-server-cloudimg-amd64-20190119"\nopenstack_networking_subnet_dns_nameservers = ["172.19.80.70"]\nopenstack_password                          = "'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$OPENSTACK_PASSWORD")]),s._v('"\n# drivetrain-team\nopenstack_tenant_name                       = "mirantis-services-team"\nopenstack_user_name                         = "'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$USER")]),s._v('"\nopenstack_user_domain_name                  = "ldap_mirantis"\nprefix                                      = "'),t("span",{pre:!0,attrs:{class:"token variable"}},[s._v("$USER")]),s._v('-k8s-istio-workshop"\nEOF')]),s._v("\n")])])]),t("p",[s._v("Download Terraform components:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("terraform init -var-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("terrafrom/openstack/terraform.tfvars terrafrom/openstack\n")])])]),t("p",[s._v("Create VMs in OpenStack:")]),s._v(" "),t("div",{staticClass:"language-bash extra-class"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("terraform apply -auto-approve -var-file"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("terrafrom/openstack/terraform.tfvars terrafrom/openstack\n")])])]),t("p",[s._v("Output:")]),s._v(" "),t("div",{staticClass:"language-shell extra-class"},[t("pre",{pre:!0,attrs:{class:"language-shell"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("..")]),s._v(".\nvms_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    pruzicka-k8s-istio-workshop-node01.01.localdomain,\n    pruzicka-k8s-istio-workshop-node02.01.localdomain,\n    pruzicka-k8s-istio-workshop-node03.01.localdomain\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nvms_public_ip "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("\n    172.16.240.185,\n    172.16.242.218,\n    172.16.240.44\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])])]),t("p",[s._v("At the end of the output you should see 3 IP addresses which\nshould be accessible by ssh using your public key "),t("code",[s._v("~/.ssh/id_rsa.pub")]),s._v(".")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://www.openstack.org/themes/openstack/images/openstack-logo/2016R/OpenStack-Logo-Horizontal.SVG",alt:"Openstack",title:"Openstack"}})])])},[],!1,null,null,null);a.default=r.exports}}]);